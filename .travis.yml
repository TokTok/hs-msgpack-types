---
language: generic
dist: xenial
os: linux

env:
  global:
    - PACKAGE=msgpack-types
    # HACKAGE_USERNAME=[secure]
    - secure: "jicOwfg/YO+V/SOew9Ui4YKsYECZQD9noMq4rN5SHrQjTDvDEZE92US01Xw09YOfQe+BCRWiy18i9GThWeXAJHXZh06c1e/KjDLnMWWqgt4QSmepSRdN2ImYF/I3t7aG2Zp3QYCrqFjq66hUw/danQqUIpMpJ3M7IVyF/U5eq/U+BV243o5BDnaEZDLRbwWsFAN7Y4UX5n3aFoaTBYyU4gkRUmTSkU19QV4pW9izhnA8AyqPWqUZyqTOQOnmDPLC4j51vzEnduzv7kfv4l/AYk87hw96KVySo+Hvd2841GaoFHAgok0CS+sbmzrUjnmHsVBqlslNpro7FMo0FnUnLdV/dnssjsMt/FtVaeKacWD1jf2WFKLAFoEJzgrb8LIpUvYiSHjYOP5vY8a0/6nEDM6pE3/YasSCD0j6uWZfA4G3JmNSi4cqKzCz/panQbZxAxj75M61vDcP5BnAtTVd5yJ7aQSXjEMOWTYLWgf6JdzzjJCia/YMzmconjmF5enKuv5RZfasQoHhhP4ZHlojcEYCH+G3oM4oL7NNIQLpk27yF4vS340jHUJSKoYsM2ysTx2dTnyd97fhfAPwzwI3ZQRHMZK1GcDpv+K42Xu1DkXcIqADJEkhZirTuLV6kNC0OZlxwrYmqE6qvYWMhpvRgG2dmppEV9/GgAY0jnYQkkU="
    # HACKAGE_PASSWORD=[secure]
    - secure: "qzPuYqUd2YyxK6b07Tl5ptqilCVhaT2bLN0hlEmyBAvnduoGWnUlRG9wprhNaJhqDF6DilQC3PvjOMcly0vw6trQkR6Gtm4bpnPXEGhIeVDUEukRaX9Jo/W8hAaVPlAPOeyPRoCI8dsRpzzYfIlbwq0snxEdXaEHtbZWv2RqsYKyZURwDlG/c4I+cTWZwQA4JGEQSRBV8HZm4B1jSfKjJOe8bt8PtYOpZ4rRVZrK/jjfIugiQ4o5GTX09oLkraK6rQQrI82FiJwuSUqXaVAlz5DM9NyvDnY3oeOytSRqLsecDiNCoT5rMjfMMm+H4LNn6cLYE0juSoBIMU8Ei2dL01s6ZB7z1Et+W9OqhUpAM5peY1QCoqGCLJwVKNT+52noF1sD0fbuDHTuiNL9SqVJLuC2kB807u7a8uiAu0eov3j64HnsRWauj2pP1ZLosnV6Rr/YjbsMOGm0XewqLUd4UrC4XUpI3TwJUg7pEyTaCvMbsbx/qMjvZI+0A29Ah3JWINaCvFAxxTS4NuMXDQTCQuDFmvYcepbcO5t20NNfzte5dX/jRBCTLmcDcru6xjq6Pqi5ObKNCnIYpPq7gnaIxUl0zNO9wcTGb8g0QijXYOe/AUPQfoEv7odg6qw6/nf55psmeilETtCmGpKxitg9XACTCncG8bDipPYRBOBUqts="

cache:
  directories:
    - $HOME/.stack

before_install:
  - export PATH=$HOME/.local/bin:$PATH
  - travis_retry curl -L https://github.com/TokTok/hs-tools/releases/download/v0.6/hs-tools-v0.6.tar.gz | tar xz -C $HOME

script:
  - hlint .
  - stylish-haskell-lhs -i .
  - git diff --exit-code
  - travis_wait stack --no-terminal test --coverage
  - shc $PACKAGE testsuite

before_deploy:
  - stack sdist --tar-dir .

deploy:
  provider: releases
  token:
    secure: "cIoa8eJDkJXZ8uCF64O2SOgThvnZsyTmTx0AN5gT/w5vSreCpbT6YiHGR690y6ObMaDUVDZFBqBJm0vjcV9GeuOXleLW3Mix5MsBg8mBzzm+xnh4kuRK5wTxLqzkFCVnbvawW9BEBv9wSoLtT12FVpsStzFBO+RJWnWMTiOjCDYO+b4lCB6ZrspVPSYAjQvLuk06ptwrJEUepgMpF81lniadt0OhaBD6s4HyyT4zBSZucK3xZsOyAdVmekr/4sT7OOtFfw2Hlrq99x9gWle8h80spIOXwrFUJTuwsFmIepO7ZVhx8Qhra6aqSaltIootcrKkOqCNeqbwJNDhiH99rXcPeyvH18R18oGSYJS1MQqRhJl/G8V91SplPDVSftmPOz39HmNU4e+W0bNTVwzyEQ9vT1Fs/1lpFg4EysA3kNXNILXXvlmwTQrtGZe7bBmD7BRIUDUJ3cIXSD/z1u//sBVrboC24RW0BedWn+bu8vR+51FQTNU0BWaFYi4AIaaf5a8PoFTQtZBr5+9wrPohQGcgFUcnDXPRusNfSJpXIIKZ7+5a5+mR79iMLrd+YTOBXPvpjVYmGPsAVTHibbMsxOmKI1kEW/pUM3zKqYRtXpLzM2wktv+/FdcSZPnIMU8M32UH6q21Thl6+F4TCAOwcx7wo1lbwaPL0rYcdMOFrzk="
  file: $PACKAGE-$TRAVIS_TAG.tar.gz
  skip_cleanup: true
  on:
    repo: TokTok/hs-msgpack-types
    tags: true

after_deploy:
  - mkdir -p "$HOME/.stack/upload"
  - echo "{\"username\":\"$HACKAGE_USERNAME\",\"password\":\"$HACKAGE_PASSWORD\"}" > $HOME/.stack/upload/credentials.json
  # TODO(iphydf): Enable this once the above deploy part is working.
  - echo stack --no-terminal upload .
